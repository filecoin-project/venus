# 重构日记

- [ ] 关于 venus-devtool 部分，也就是开发过程中需要用到的各类辅助工具放置位置：从现在来看，以一个单独的、内部的 module 模式比较好，可以避免在 venus/v2 中显式声明对新的 module 进行 replace，从而也就避免了出现依赖关系上的“难以厘清”。

- [ ] 在抽取 `chain.BlockHeader` 的过程中，出现了同样的序列化过程反复手写， `cachedBytes` 与 `cachedCid` 用上了又没完全用上的情况，这个应该是在处理历史遗留问题时追求“快速实现”的结果。同时，在写好实现之后立刻进行基本的测试编写帮助找出了 `SignatureData` 方法中，由于结构体复制后没有清除 cache 导致的bug。

    由此可见，测试用例，尤其是基础功能性的测试用例，应当在逻辑代码实现后立即着手编写，这样做一方面是可以尽快找出问题，避免系统复杂之后更为困难的 debug 过程；另一方面则是可以趁着记忆仍然“新鲜”，保障有一个较好的测试覆盖率。

- [ ] 在处理 `chain.BlockHeader` 中的 `cachedBytes` 和 `cachedCid` 字段时，出现了反复。最开始认为可以抽象出一类 `cborCache` 类型，专门进行 data 和 cid 的缓存。接着发现，在 `Message` 这类对象中如果使用这样一个缓存，很有可能出现修改了 Message 的属性之后得不到正确的序列化结果和 cid 的问题。

    因此，将 `chain.BlockHeader` 中的 cache 字段也做了移除处理。如果仔细去想，这里 cache 字段出现的意义到底是什么？我认为，这类对象提供了太多需要进行雷同的序列化过程的方法。如 `Cid` 这个方法，甚至是先序列化再计算数据的哈希值。这导致序列化被反复无序地使用，我想这才是加上 cache 字段的初衷。

	那么实际上，我们真正要做的是减少序列化被使用的位置，并尽可能让且有序，如不提供一个只返回 Cid 的方法，而同时返回序列化结果和 Cid
