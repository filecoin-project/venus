name: basic checks

on: ["push", "pull_request"]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: dependencies
        run: sudo apt install mesa-opencl-icd ocl-icd-opencl-dev gcc git bzr jq pkg-config curl clang build-essential hwloc libhwloc-dev wget -y

      - uses: actions/checkout@v2
        with:
          submodules: 'true'

      - name: setup go
        uses: actions/setup-go@v2
        with:
          go-version: '1.16'

      - name: deps
        run: make deps

      - name: build
        run: make all

      - name: tests-shared
        run: make test-venus-shared

      - name: compatible-checks
        run: |
          make compatible-all
          git --no-pager diff
          git --no-pager diff --quiet

      - name: check api docs
        run: |
          make api-docs
          git --no-pager diff
          git --no-pager diff --quiet

      - name: check cbor-gen
        run: |
          make cborgen
          git --no-pager diff
          git --no-pager diff --quiet

      - name: check mock pai
        run: |
          make mock-api-gen
          git --no-pager diff
          git --no-pager diff --quiet
