version: 2.1 # use CircleCI 2.0

orbs:
  go: venus/go-pkg-test@1.0.1

jobs:
  test_all:
    executor:
      name: go/default
      tag: 'cimg/go:1.18.1'
    steps:
      - go/setup_env:
          install_ffi: true
      - install_deps:
          run: sudo apt-get -o Acquire::Retries=3 update && sudo apt-get -o Acquire::Retries=3 install hwloc libhwloc-dev mesa-opencl-icd ocl-icd-opencl-dev -y
      - go/test:
          display-name: unit_test_chain
          suite: "unit_test_chain"
          target: "./pkg/chain/..."
      - go/test:
          display-name: unit_test_beacon
          suite: "unit_test_beacon"
          target: "./pkg/beacon/..."
      - go/test:
          display-name: unit_test_chainsync
          suite: "unit_test_chainsync"
          target: "./pkg/chainsync/..."
      - go/test:
          display-name: unit_test_clock
          suite: "unit_test_clock"
          target: "./pkg/clock/..."
      - go/test:
          display-name: unit_test_consensus
          suite: "unit_test_consensus"
          target: "./pkg/consensus/..."
      - go/test:
          display-name: unit_test_crypto
          suite: "unit_test_crypto"
          target: "./pkg/crypto/..."
      - go/test:
          display-name: unit_test_market
          suite: "unit_test_market"
          target: "./pkg/market/..."
      - go/test:
          display-name: unit_test_messagepool
          suite: "unit_test_messagepool"
          target: "./pkg/messagepool/..."
      - go/test:
          display-name: unit_test_net
          suite: "unit_test_net"
          target: "./pkg/net/..."
      - go/test:
          display-name: unit_test_paychmgr
          suite: "unit_test_paychmgr"
          target: "./pkg/paychmgr/..."
      - go/test:
          display-name: unit_test_repo
          suite: "unit_test_repo"
          target: "./pkg/repo/..."
      - go/test:
          display-name: unit_test_state
          suite: "unit_test_state"
          target: "./pkg/state/..."
      - go/test:
          display-name: unit_test_wallet
          suite: "unit_test_wallet"
          target: "./pkg/wallet/..."

workflows:
  ci:
    jobs:
      - test_all
